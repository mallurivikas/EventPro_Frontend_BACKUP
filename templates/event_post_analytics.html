{% extends "event_base.html" %}

{% block title %}Post-Event Analytics - {{ event_title }}{% endblock %}

{% block page_title %}Post-Event Analytics{% endblock %}

{% block content %}
<!-- Event Status Check -->
<div id="not-completed-message">
    <div class="flex items-center justify-center min-h-96">
        <div class="text-center">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="calendar-x" class="w-12 h-12 text-gray-400"></i>
            </div>
            <h2 class="text-2xl font-semibold text-gray-900 mb-2">NO INFO YET</h2>
            <p class="text-gray-600 mb-6">This event hasn't been completed yet. Post-event analytics will be available after the event ends.</p>
            <div class="flex space-x-4 justify-center">
                <a href="/events/{{ event_id }}/pre-event" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Pre-Event Analytics
                </a>
                <a href="/events/{{ event_id }}/engagement" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i data-lucide="radio" class="w-4 h-4 mr-2"></i>
                    Event Engagement
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Post-Event Content (hidden by default) -->
<div id="post-event-content" class="hidden">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Attendees</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1" id="total-attendees">0</p>
                    <p class="text-green-600 text-sm mt-1">Event completed</p>
                </div>
                <div class="p-3 rounded-lg bg-green-50">
                    <i data-lucide="users" class="w-6 h-6 text-green-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Avg Rating</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1" id="avg-rating">0</p>
                    <p class="text-blue-600 text-sm mt-1">Out of 5</p>
                </div>
                <div class="p-3 rounded-lg bg-blue-50">
                    <i data-lucide="star" class="w-6 h-6 text-blue-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Feedback Count</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1" id="feedback-count">0</p>
                    <p class="text-purple-600 text-sm mt-1">Responses</p>
                </div>
                <div class="p-3 rounded-lg bg-purple-50">
                    <i data-lucide="message-circle" class="w-6 h-6 text-purple-600"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">NPS Score</p>
                    <p class="text-3xl font-bold text-gray-900 mt-1" id="nps-score">0</p>
                    <p class="text-orange-600 text-sm mt-1">Net Promoter</p>
                </div>
                <div class="p-3 rounded-lg bg-orange-50">
                    <i data-lucide="trending-up" class="w-6 h-6 text-orange-600"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Rating Distribution</h3>
            <div class="h-64">
                <canvas id="ratingChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Sentiment Analysis</h3>
            <div class="h-64">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Rating Breakdown -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Rating Breakdown</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="rating-breakdown">
            <!-- Rating circles will be populated here -->
        </div>
    </div>

    <!-- Feedback Comments -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Recent Feedback</h3>
        <div class="space-y-4" id="feedback-list">
            <!-- Feedback will be populated here -->
        </div>
    </div>

    <!-- Export Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Export Data</h3>
            <div class="space-y-3">
                <button onclick="exportData('summary')" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Download Summary Report</span>
                </button>
                <button onclick="exportData('feedback')" class="w-full flex items-center justify-center space-x-2 px-4 py-3 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    <span>Export Feedback Data</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Follow-up Actions</h3>
            <div class="space-y-3">
                <button onclick="sendThankYou()" class="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    <span>Send Thank You Emails</span>
                </button>
                <button onclick="scheduleFollowUp()" class="w-full flex items-center justify-center space-x-2 px-4 py-3 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Schedule Follow-up</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const eventId = "{{ event_id }}";
    let ratingChart, sentimentChart;
    
    // Check event status on page load
    async function checkEventStatus() {
        try {
            const response = await fetch(`/api/events/${eventId}/status`);
            const data = await response.json();
            
            if (data.status === 'completed') {
                // Show post-event content
                document.getElementById('not-completed-message').classList.add('hidden');
                document.getElementById('post-event-content').classList.remove('hidden');
                loadPostEventData();
            } else {
                // Show not completed message
                document.getElementById('not-completed-message').classList.remove('hidden');
                document.getElementById('post-event-content').classList.add('hidden');
            }
        } catch (error) {
            console.error('Error checking event status:', error);
            // Default to showing not completed message
            document.getElementById('not-completed-message').classList.remove('hidden');
            document.getElementById('post-event-content').classList.add('hidden');
        }
    }
    
    // Load post-event data
    async function loadPostEventData() {
        try {
            const response = await fetch('/api/feedback');
            const data = await response.json();
            
            updateStats(data);
            createRatingChart(data);
            createSentimentChart(data);
            createRatingBreakdown(data.ratings || []);
            displayFeedback(data.comments || []);
            
        } catch (error) {
            console.error('Error loading post-event data:', error);
            loadMockPostEventData();
        }
    }
    
    function loadMockPostEventData() {
        const mockData = {
            total_responses: 156,
            avg_rating: 4.6,
            nps: 67,
            ratings: [
                { category: 'Overall Satisfaction', rating: 85 },
                { category: 'Content Quality', rating: 92 },
                { category: 'Organization', rating: 78 },
                { category: 'Venue Quality', rating: 88 }
            ],
            sentiment: { positive: 68, neutral: 22, negative: 10 },
            comments: [
                {
                    rating: 5,
                    comment: 'Excellent conference! Very informative.',
                    attendee: 'Sarah Johnson',
                    session: 'Tech Panel Discussion'
                },
                {
                    rating: 4,
                    comment: 'Great speakers and networking opportunities.',
                    attendee: 'Mike Chen',
                    session: 'Keynote Address'
                }
            ]
        };
        
        updateStats(mockData);
        createRatingChart(mockData);
        createSentimentChart(mockData);
        createRatingBreakdown(mockData.ratings);
        displayFeedback(mockData.comments);
    }
    
    function updateStats(data) {
        document.getElementById('total-attendees').textContent = '245';
        document.getElementById('avg-rating').textContent = data.avg_rating || '0';
        document.getElementById('feedback-count').textContent = data.total_responses || '0';
        document.getElementById('nps-score').textContent = data.nps || '0';
    }
    
    function createRatingChart(data) {
        const ctx = document.getElementById('ratingChart').getContext('2d');
        
        ratingChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.ratings.map(r => r.category),
                datasets: [{
                    label: 'Rating %',
                    data: data.ratings.map(r => r.rating),
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
    
    function createSentimentChart(data) {
        const ctx = document.getElementById('sentimentChart').getContext('2d');
        
        sentimentChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    data: [data.sentiment.positive, data.sentiment.neutral, data.sentiment.negative],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2
            }
        });
    }
    
    function createRatingBreakdown(ratings) {
        const container = document.getElementById('rating-breakdown');
        container.innerHTML = '';
        
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
        
        ratings.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'text-center';
            div.innerHTML = `
                <div class="relative w-24 h-24 mx-auto mb-3">
                    <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 36 36">
                        <path
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="#e5e7eb"
                            stroke-width="2"
                        />
                        <path
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none"
                            stroke="${colors[index]}"
                            stroke-width="2"
                            stroke-dasharray="${item.rating}, 100"
                        />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-lg font-bold text-gray-900">${item.rating}%</span>
                    </div>
                </div>
                <p class="text-sm font-medium text-gray-900">${item.category}</p>
            `;
            container.appendChild(div);
        });
    }
    
    function displayFeedback(comments) {
        const feedbackList = document.getElementById('feedback-list');
        feedbackList.innerHTML = '';
        
        comments.forEach(comment => {
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'p-4 border border-gray-100 rounded-lg';
            feedbackDiv.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="font-medium text-gray-900">${comment.attendee}</span>
                        <span class="text-sm text-gray-500">• ${comment.session}</span>
                    </div>
                    <div class="flex text-yellow-400">
                        ${'★'.repeat(comment.rating)}${'☆'.repeat(5 - comment.rating)}
                    </div>
                </div>
                <p class="text-gray-700">${comment.comment}</p>
            `;
            feedbackList.appendChild(feedbackDiv);
        });
    }
    
    // Action functions
    function exportData(type) {
        alert(`Exporting ${type} data... Download will start shortly.`);
    }
    
    function sendThankYou() {
        alert('Thank you emails sent to all attendees!');
    }
    
    function scheduleFollowUp() {
        alert('Follow-up survey scheduled for next week!');
    }
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', checkEventStatus);
</script>
{% endblock %}